![Python](https://img.shields.io/badge/python-3670A0?style=for-the-badge&logo=python&logoColor=ffdd54)
![Postgres](https://img.shields.io/badge/postgres-%23316192.svg?style=for-the-badge&logo=postgresql&logoColor=white)
![Redis](https://img.shields.io/badge/redis-%23DD0031.svg?style=for-the-badge&logo=redis&logoColor=white)
![FastAPI](https://img.shields.io/badge/FastAPI-005571?style=for-the-badge&logo=fastapi)
![Nginx](https://img.shields.io/badge/nginx-%23009639.svg?style=for-the-badge&logo=nginx&logoColor=white)
![Docker](https://img.shields.io/badge/docker-%230db7ed.svg?style=for-the-badge&logo=docker&logoColor=white)
![Git](https://img.shields.io/badge/git-%23F05033.svg?style=for-the-badge&logo=git&logoColor=white)

# ДесинхГраф

## Задача:
Целю проекта является программно-аппаратный комплекс по оказанию помощи в принятии решений для мед.персонала.
Проект состоит из нескольких взаимосвязанных сервисов. Клиентом в данном случае будет являться программно-аппаратный комплекс с возможностью выхода в Internet для подключения к серверу проекта, который будет развернут в облаке (или на наших серверах).
На данный момент в разработке находится сервис под названием ДесинхГраф (DesyncGraph).
Сервис является программным продуктом (пп) и предназначен для мониторинга процессов десинхронизации ритмов ЭЭГ в реальном времени.
Мониторинг процессов состоит из 2х частей:

1. Визуализация чистого или отфильтрованного входного ЭЭГ сигнала с пациента, путём построения графиков временных рядов ЭЭГ за последние 10сек.

2. Визуализация уровня силы десинхронизации, путём отрисовки   2D модели мозга пациента  на которую наносятся координаты ЭЭГ отведений в виде серых, видимых глазу точек. В процессе работы программы точки меняют свой цвет в зависимости от уровня десинхронизации. Чем сильнее десинхронизация тем краснее становится точка.

## Архитектура решений:
![schema_arch.png](schema%2Fschema_arch.png)

### Стек технологий:
Для реализации сервиса были использованы следующий технологии:
- PostgreSQL (БД с информацией)
- Redis (кэширование данных)
- FastAPI (api для взаимодействия между сервисами)
- Nginx (веб-сервер)
- Docker (контейнеризация сервисов)
- GIT (контроль версий, отслеживание рабочего процесса)
- Python 3.10 (разработка сервисов)

---
## Инструкция по запуску
1. Создайте файлы `.env` и заполните их по аналогии с `.env.example`.
2. Открыть терминал.
3. Перейти в папку с файлом docker-compose.yml
4. Выполните команду
```
docker-compose up -d --build
```
Чтобы остановить контейнер и удалить volumes выполните команду
```
docker-compose down -v
```

[//]: # (Сервис доступен по адресу: )

[//]: # (- swagger: http://localhost/api/openapi)

[//]: # (- kibana: http://localhost)

[//]: # (- admin: http://localhost/admin)

5.	Запуск docker-compose файла для требуемой операционной системы.
6.	Проверка запущенных контейнеров
7.	Переход в браузере по адресу http://localhost:8080/ и http://localhost:8001/api/openapi#/

**Примечание: При запуске проекта из "Коробки" автоматически создается клиника с адресом имеющие пустые поля. Так же создается пользователь с правами администратора, данные которого нужно указать в файле .env. Администратору требуется при запуске заполнить данные клиники.**

***Примечание: При изменении ПОЧТЫ администратора изменения вступят в силу только после перезапуска проекта*

## Как работать 

Будет запущенно два контейнера:
1. test_stream - контейнер с тестовым потоком
2. etl - контейнер с etl для чтения, трансформации и загрузки данных из потоков

Посмотреть выводы данных на экран можно подключившись в терминале к каждому контейнеру или в PyCharm в меня Services 
и выбрав нужный контейнер.

В дальнейшем контейнер tets_stream необходимо отключить.
---
## В разработке

Запуск alembic:
1.	Открываем терминал в среде разработки
Создаем миграцию: alembic revision -m "create table"
Запускаем миграцию: alembic upgrade head (апгрейд до самого конца)
После этого нужно удостовериться,что произошел апгрейд
Показать историю: alembic history --verbose
Откатить миграцию: alembic downgrade -1
Получить информацию о текущей версии: alembic current

2. Автоматическая генерация миграции: alembic revision --autogenerate -m "Database BrainFlow" 

Ссылки на источники: https://konstantinklepikov.github.io/myknowlegebase/notes/alembic.html?ysclid=lphvalp678388876810

https://habr.com/ru/companies/yandex/articles/511892/#:~:text=%D0%9C%D0%B8%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D0%B8%20%D1%81%20alembic,%D0%BC%D0%B5%D0%BD%D1%8F%20%D0%B2%D1%81%D0%B5%2C%20%D1%81%D0%BF%D0%B0%D1%81%D0%B8%D0%B1%D0%BE.

Запуск Poetry:

1. Переходим в сервис
2. Создаем pyproject.toml файл в каталоге: poetry init
3. Добавляем библиотеку в виртуальную среду проекта: poetry add *lib_name*
4. Удаляем библиотеку из виртуальной среды проекта: poetry remove *lib_name*
---
## Настройка локального домена
Для корректной работы приложения (правильного отображения ссылок в браузере) необходима настройка локально домена

Если вы работаете на системе Windows сделайте следующие шаги:
1. Открываем папку nginx_conf
2. Запустите файл host_change.bat от имени администратора

Если вы работаете на системе Linux сделайте следующие шаги:
1. Открываем консоль
2. Выполняем команду sudo путь-до-проекта/nginx_conf/add_ip_linux.sh
3. Вводим свой пароль

Для отмены изменений на Windows сделайте следующие шаги:
1. Открываем папку nginx_conf
2. Запустите файл remove_changes_win.bat от имени администратора

Для отмены изменений на Linux сделайте следующие шаги:
1. Открываем консоль
2. Выполняем команду sudo путь-до-проекта/nginx_conf/remove_ip_linux.sh
3. Вводим свой пароль


Swagger сервиса будет доступен по адресу : http://brain-flow.com/api/openapi

Для правильного версирования в коммит добавляем комментарий. Например:''fix: bug with connect''. 
Ниже перечислены ключевые слова, которые вставляются вместо "fix" и какую цифру изменяют при pr.


"releaseRules": [
          {"tag": "breaking", "release": "major"},
          {"tag": "chore", "release": false},
          {"tag": "ci", "release": false},
          {"tag": "docs", "release": false},
          {"tag": "feat", "release": "minor"},
          {"tag": "fix", "release": "patch"},
          {"tag": "refactor", "release": "patch"},
          {"tag": "security", "release": "patch"},
          {"tag": "style", "release": "patch"},
          {"tag": "test", "release": false}
        ]